{% extends 'base.html.twig' %}

{% block title %}AI Chatbot{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="row">
        {# SIDEBAR - Chat List #}
        <div class="col-md-3">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots"></i> Moje chaty
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="chat-list" class="list-group list-group-flush">
                        <div class="text-center p-3 text-muted">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Načítavam...</span>
                            </div>
                            Načítavam chaty...
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button id="new-chat-btn" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-plus-circle"></i> Nový chat
                    </button>
                </div>
            </div>
        </div>

        {# MAIN CONTENT - AI Chatbot #}
        <div class="col-md-9">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-robot"></i> AI Chatbot
                    </h3>
                </div>
                <div class="card-body">
                    {% for message in app.flashes('error') %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}

                    {% for message in app.flashes('success') %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}

                    <p class="text-muted mb-4">
                        Opýtaj sa AI asistenta na čokoľvek! Odpovie ti v slovenčine.
                    </p>

                    <form method="POST" action="{{ path('ai_chatbot_submit') }}" id="chat-form">
                        <div class="mb-3">
                            <label for="question" class="form-label">Tvoja otázka:</label>
                            <textarea 
                                class="form-control" 
                                id="question" 
                                name="question" 
                                rows="4" 
                                placeholder="Napr: Ako funguje internet?"
                                required
                            ></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-send"></i> Opýtaj sa AI
                            </button>
                            
                            <button type="button" id="save-chat-btn" class="btn btn-success btn-lg" disabled>
                                <i class="bi bi-floppy"></i> Uložiť túto konverzáciu
                            </button>
                        </div>
                    </form>

                    <div id="ai-response-container" style="display: none;" class="mt-4">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-robot"></i> AI Odpoveď
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="ai-response" class="ai-response"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center text-muted">
                <small>
                    <i class="bi bi-info-circle"></i> 
                    Powered by Groq API (llama-3.1-8b-instant)
                </small>
            </div>
        </div>
    </div>
</div>

<style>
.ai-response {
    font-size: 1.1rem;
    line-height: 1.6;
    white-space: pre-wrap;
}

.chat-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.chat-item:hover {
    background-color: #f8f9fa;
}

.chat-item.active {
    background-color: #e7f3ff;
    border-left: 3px solid #0d6efd;
}

.delete-chat-btn {
    opacity: 0.6;
    transition: opacity 0.2s;
}

.delete-chat-btn:hover {
    opacity: 1;
    color: #dc3545;
}
</style>

<script>
let currentQuestion = '';
let currentAnswer = '';

async function loadChats() {
    try {
        const response = await fetch('/api/chats');
        const data = await response.json();

        if (data.success) {
            renderChats(data.data);
        } else {
            showError('Chyba pri načítaní chatov: ' + data.error);
        }
    } catch (error) {
        showError('Chyba pri načítaní chatov: ' + error.message);
    }
}

function renderChats(chats) {
    const chatList = document.getElementById('chat-list');

    if (chats.length === 0) {
        chatList.innerHTML = `
            <div class="text-center p-3 text-muted">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">Zatiaľ žiadne chaty</p>
                <small>Vytvor prvý chat!</small>
            </div>
        `;
        return;
    }

    chatList.innerHTML = chats.map(chat => `
        <div class="list-group-item list-group-item-action chat-item d-flex justify-content-between align-items-center" 
             data-chat-id="${chat.id}">
            <div class="flex-grow-1" onclick="loadChat(${chat.id})">
                <div class="fw-bold">
                    <i class="bi bi-chat-text"></i> ${escapeHtml(chat.title)}
                </div>
                <small class="text-muted">
                    ${new Date(chat.created_at).toLocaleString('sk-SK')}
                </small>
            </div>
            <button class="btn btn-sm btn-link delete-chat-btn p-0" 
                    onclick="deleteChat(${chat.id}, event)"
                    title="Zmazať chat">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `).join('');
}

async function loadChat(chatId) {
    try {
        const response = await fetch('/api/chats');
        const data = await response.json();

        if (data.success) {
            const chat = data.data.find(c => c.id === chatId);
            
            if (chat) {
                displayChatMessages(chat);
                
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
            }
        }
    } catch (error) {
        showError('Chyba pri načítaní chatu: ' + error.message);
    }
}

function displayChatMessages(chat) {
    const responseContainer = document.getElementById('ai-response-container');
    const responseDiv = document.getElementById('ai-response');
    
    const lastUserMessage = chat.messages.find(m => m.role === 'user');
    const lastAssistantMessage = chat.messages.find(m => m.role === 'assistant');
    
    if (lastUserMessage) {
        document.getElementById('question').value = lastUserMessage.content;
        currentQuestion = lastUserMessage.content;
    }
    
    if (lastAssistantMessage) {
        responseDiv.textContent = lastAssistantMessage.content;
        responseContainer.style.display = 'block';
        currentAnswer = lastAssistantMessage.content;
        document.getElementById('save-chat-btn').disabled = true;
    }
}

async function saveChat() {
    if (!currentQuestion || !currentAnswer) {
        showError('Najprv sa opýtaj AI na otázku!');
        return;
    }

    try {
        const response = await fetch('/api/chats', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: currentQuestion.substring(0, 50) + (currentQuestion.length > 50 ? '...' : ''),
                messages: [
                    { role: 'user', content: currentQuestion },
                    { role: 'assistant', content: currentAnswer }
                ]
            })
        });

        const data = await response.json();

        if (data.success) {
            showSuccess('Chat bol úspešne uložený!');
            loadChats();
            document.getElementById('save-chat-btn').disabled = true;
        } else {
            showError('Chyba pri ukladaní: ' + data.error);
        }
    } catch (error) {
        showError('Chyba pri ukladaní: ' + error.message);
    }
}

async function deleteChat(chatId, event) {
    event.stopPropagation();

    if (!confirm('Naozaj chceš zmazať tento chat?')) {
        return;
    }

    try {
        const response = await fetch(`/api/chats/${chatId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showSuccess('Chat bol zmazaný!');
            loadChats();
        } else {
            showError('Chyba pri mazaní: ' + data.error);
        }
    } catch (error) {
        showError('Chyba pri mazaní: ' + error.message);
    }
}

function newChat() {
    document.getElementById('question').value = '';
    document.getElementById('ai-response-container').style.display = 'none';
    currentQuestion = '';
    currentAnswer = '';
    
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    document.getElementById('save-chat-btn').disabled = true;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    alert('❌ ' + message);
}

function showSuccess(message) {
    alert('✅ ' + message);
}

document.getElementById('save-chat-btn').addEventListener('click', saveChat);
document.getElementById('new-chat-btn').addEventListener('click', newChat);

document.addEventListener('DOMContentLoaded', function() {
    loadChats();
});
</script>
{% endblock %}